name: release-tee

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.7.0). If empty, uses version from Cargo.toml"
        type: string
        required: false

env:
  CARGO_TERM_COLOR: always

permissions:
  id-token: write      # OIDC token for Sigstore signing
  attestations: write  # Persist attestations
  contents: write      # Release artifact upload

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.release_info.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Get version
        id: release_info
        run: |
          if [[ -n "${{ github.event.inputs.tag }}" ]]; then
            echo "tag_name=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            cargo install cargo-get
            echo "tag_name=v$(cargo get workspace.package.version)" >> $GITHUB_OUTPUT
          fi

  build-contracts:
    runs-on: ubuntu-latest
    needs: prepare
    container:
      image: ghcr.io/dojoengine/katana-dev:latest
    steps:
      - uses: actions/checkout@v4
      - name: Build contracts
        run: make contracts
      - name: Upload contract artifacts
        uses: actions/upload-artifact@v4
        with:
          name: contract-artifacts
          path: ./crates/contracts/build
          retention-days: 1

  reproducible-build:
    name: Reproducible TEE Build
    needs: [prepare, build-contracts]
    runs-on: ubuntu-latest-8-cores
    outputs:
      binary-hash: ${{ steps.hash.outputs.sha384 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download contract artifacts
        uses: actions/download-artifact@v4
        with:
          name: contract-artifacts
          path: ./crates/contracts/build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build reproducible binary
        run: |
          docker build \
            -f reproducible.Dockerfile \
            -t katana-reproducible:${{ needs.prepare.outputs.tag_name }} \
            --build-arg SOURCE_DATE_EPOCH=$(git log -1 --format=%ct) \
            --no-cache \
            .

      - name: Extract binary from container
        run: |
          docker create --name katana-extract katana-reproducible:${{ needs.prepare.outputs.tag_name }}
          docker cp katana-extract:/katana ./katana-reproducible
          docker rm katana-extract

      - name: Calculate binary hash
        id: hash
        run: |
          SHA384=$(sha384sum ./katana-reproducible | cut -d ' ' -f 1)
          echo "sha384=${SHA384}" >> $GITHUB_OUTPUT
          echo "Binary SHA-384: ${SHA384}"

      - name: Archive reproducible binary
        env:
          VERSION_NAME: ${{ needs.prepare.outputs.tag_name }}
        run: |
          tar -czvf "katana_${VERSION_NAME}_linux_amd64_tee.tar.gz" katana-reproducible
          sha384sum katana-reproducible > "katana_${VERSION_NAME}_linux_amd64_tee.sha384"

      - name: Generate build provenance attestation
        id: attest
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ./katana-reproducible

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tee-release-artifacts
          path: |
            katana_${{ needs.prepare.outputs.tag_name }}_linux_amd64_tee.tar.gz
            katana_${{ needs.prepare.outputs.tag_name }}_linux_amd64_tee.sha384

      - name: Summary
        run: |
          echo "## TEE Reproducible Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**SHA-384:** \`${{ steps.hash.outputs.sha384 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verify Attestation" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "gh attestation verify ./katana-reproducible --repo ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
